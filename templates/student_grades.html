<!doctype html>
<html>
<head>
<title>Student Grades</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
.tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid #ddd;
}
.tab-button {
  background-color: #f0f0f0;
  border: 1px solid #ddd;
  border-bottom: none;
  padding: 10px 15px;
  cursor: pointer;
  border-top-left-radius: 5px;
  border-top-right-radius: 5px;
  margin-right: 5px;
  font-weight: bold;
}
.tab-button.active {
  background-color: #fff;
  border-color: #007bff;
  color: #007bff;
  border-bottom: 1px solid #fff; 
}
.tab-content {
  display: none; 
  padding: 20px 0;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 8px 8px;
  background: #f9f9f9;
}
.tab-content.active {
  display: block; 
}

table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #333; padding: 3px; text-align: center; vertical-align: middle; }
th { background-color: #f0f0f0; font-weight: bold; font-size: 11px; }
input[type="text"], input[type="number"] { 
  width: 100%; 
  border: none; 
  text-align: center; 
  padding: 2px; 
  font-size: 11px;
  box-sizing: border-box;
}
input[readonly] { 
  background-color: #f8f9fa; 
  color: #333;
}
.student-row { background-color: white; }
.stats-row { background-color: #e6f3ff; }
.total-points-row { background-color: #ffff99; font-weight: bold; }
.exam-contribution-row { background-color: #90EE90; }
.performance-row { background-color: #FFA500; color: #d63031; font-weight: bold; }
.submit-btn { 
  background: #007bff; 
  color: white; 
  padding: 10px 20px; 
  border: none; 
  border-radius: 4px; 
  cursor: pointer; 
  margin-top: 20px; 
  text-decoration: none; 
  display: inline-block;
}
.id-col { width: 30px; }
.student-info-col { width: 120px; }
.question-col { width: 45px; }
.total-col { width: 60px; }

.top-right-button {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: #6f42c1; 
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none; 
}
.top-right-button:hover {
    background-color: #5936a0;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;

/* Not validasyonu i√ßin ek stiller */
.grade-input.error {
    border: 2px solid #f44336 !important;
    background-color: #ffebee !important;
    color: #d32f2f !important;
}

.grade-input.valid {
    border: 2px solid #4caf50 !important;
    background-color: #e8f5e8 !important;
    color: #2e7d32 !important;
}

.grade-input.warning {
    border: 2px solid #ff9800 !important;
    background-color: #fff3e0 !important;
    color: #ef6c00 !important;
}

.grade-input:focus {
    outline: none;
    box-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
}

/* Bildirim stilleri */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease-out;
}

.notification-warning {
    background-color: #ff9800;
}

.notification-error {
    background-color: #f44336;
}

.notification-success {
    background-color: #4caf50;
}

.notification-info {
    background-color: #2196f3;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 95%;
    max-width: 1400px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 8px;
    position: relative;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 15px;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
}

/* Bloom Mapping Table Styles */
.bloom-table { 
    border-collapse: collapse; 
    width: 100%; 
    margin-bottom: 20px;
    border: 2px solid #2c3e50;
    font-size: 10px;
}
.bloom-table th, .bloom-table td { 
    border: 1px solid #34495e; 
    padding: 4px 2px; 
    text-align: center; 
    vertical-align: middle;
    font-size: 10px;
}

.main-header {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    font-weight: bold;
    font-size: 11px;
}
.evaluation-header {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    font-weight: bold;
}
.question-header {
    background: linear-gradient(135deg, #f39c12, #d68910);
    color: white;
    font-size: 9px;
    font-weight: bold;
}
.performance-header {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
    font-weight: bold;
}

.clo-cell {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
    color: white;
    font-weight: bold;
    min-width: 60px;
}

.input-cell {
    background: #ecf0f1;
    padding: 1px;
}
.input-cell input {
    width: 35px;
    height: 20px;
    border: 1px solid #bdc3c7;
    text-align: center;
    font-size: 9px;
    border-radius: 3px;
    padding: 2px;
}
.input-cell input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 3px rgba(52, 152, 219, 0.3);
}

.input-cell input:not([value=""]) {
    background-color: #fff3cd;
    font-weight: bold;
    color: #856404;
}

.calc-cell {
    background: #d5f4e6;
    font-weight: bold;
    color: #27ae60;
}

.total-row {
    background: linear-gradient(135deg, #34495e, #2c3e50);
    color: white;
    font-weight: bold;
}

.midterm-col { background-color: rgba(52, 152, 219, 0.1); }
.final-col { background-color: rgba(155, 89, 182, 0.1); }
.quiz-col { background-color: rgba(230, 126, 34, 0.1); }
.project-col { background-color: rgba(231, 76, 60, 0.1); }

.btn-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}
.submit-btn, .download-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    color: white;
    display: inline-block;
}
.submit-btn {
    background: linear-gradient(135deg, #27ae60, #229954);
}
.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}
.download-btn {
    background: #007bff;
}
.download-btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

</style>
</head>
<body>
<h2>Student Information and Grade Entry</h2>



<!-- Course Information Display -->
<div style="background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px; backdrop-filter: blur(5px);">
    <h3 style="color: #667eea; font-size: 1.1rem; margin-bottom: 10px; font-weight: 600;">üìö Course Information</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <div style="display: flex; flex-direction: column;">
            <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500; margin-bottom: 2px;">Course Code:</span>
            <span style="font-size: 1rem; color: #2c3e50; font-weight: 600;">{{ session.get('course_code', 'N/A') }}</span>
        </div>
        <div style="display: flex; flex-direction: column;">
                                    <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500; margin-bottom: 2px;">Instructor:</span>
            <span style="font-size: 1rem; color: #2c3e50; font-weight: 600;">{{ session.get('teacher_name', 'N/A') }}</span>
        </div>
        <div style="display: flex; flex-direction: column;">
            <span style="font-size: 0.85rem; color: #6c757d; font-weight: 500; margin-bottom: 2px;">Semester:</span>
            <span style="font-size: 1rem; color: #2c3e50; font-weight: 600;">{{ session.get('semester', 'N/A') }}</span>
        </div>
    </div>
</div>

<!-- Bloom Level Mapping Modal -->
<div id="bloomModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>CLOs ‚Äì Questions Matrix</h2>
        
                 <!-- Automatic Calculation Information -->
         <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 5px; padding: 10px; margin-bottom: 20px; text-align: center; font-size: 11px;">
             <strong>‚ÑπÔ∏è Information:</strong> All values (QCT, W, SPM, BL) are automatically calculated and entered. 
             QCT: (Question points √ó Exam percentage) √∑ 100 | W: 1 √∑ CLO count | SPM: Student performance median | BL: Bloom level
                           <br><strong>‚ö†Ô∏è Important:</strong> These fields are system-generated and cannot be modified manually.
         </div>

        <form method="post" id="bloomForm">
            <table class="bloom-table">
                <!-- Main Headers -->
                                 <tr>
                     <th class="main-header" rowspan="2">CLO</th>
                    {% for exam in exams %}
                        <th class="evaluation-header" colspan="{{ exam.question_count * 4 }}">{{ exam.name }}</th>
                    {% endfor %}
                    <th class="performance-header" colspan="4">CLO Performance Values</th>
                </tr>
                
                                 <!-- Question Numbers -->
                 <tr>
                     {% for exam in exams %}
                         {% for q in range(exam.question_count) %}
                             <th class="question-header" colspan="4">Q{{ q+1 }}</th>
                         {% endfor %}
                     {% endfor %}
                     <th class="performance-header">Max CLO Score</th>
                     <th class="performance-header">CLO Score</th>
                     <th class="performance-header">MW-BL</th>
                     <th class="performance-header">Weighted BL Sum</th>
                 </tr>
                 


                <!-- CLO Data Rows -->
                {% for clo_idx, clo in enumerate(clos) %}
                <tr>
                    <td class="clo-cell">{{ clo_names[clo_idx] if clo_names and clo_idx < clo_names|length else 'CLO ' + clo|string }}</td>
                    {% for exam_idx, exam in enumerate(exams) %}
                        {% for q in range(exam.question_count) %}
                            {% set global_q_idx = all_questions_flat_map[exam_idx][q] %}
                            <td class="input-cell 
                                {% if exam.name == 'Midterm' %}midterm-col
                                {% elif exam.name == 'Final' %}final-col
                                {% elif exam.name == 'Quiz' %}quiz-col
                                {% elif exam.name == 'Project' %}project-col
                                {% endif %}">
                                <input type="number" step="0.01" min="0" max="100" 
                                       name="qct_{{ clo_idx }}_{{ global_q_idx }}" 
                                       value="{% if clo_q_data and clo_idx < clo_q_data|length and global_q_idx in clo_q_data[clo_idx] and clo_q_data[clo_idx][global_q_idx]['qct'] != 0 %}{{ clo_q_data[clo_idx][global_q_idx]['qct'] }}{% endif %}"
                                       readonly style="background-color: #f8f9fa; color: #495057; font-weight: bold;">
                            </td>
                            <td class="input-cell 
                                {% if exam.name == 'Midterm' %}midterm-col
                                {% elif exam.name == 'Final' %}final-col
                                {% elif exam.name == 'Quiz' %}quiz-col
                                {% elif exam.name == 'Project' %}project-col
                                {% endif %}">
                                <input type="number" step="0.01" min="0" 
                                       name="w_{{ clo_idx }}_{{ global_q_idx }}" 
                                       value="{% if clo_q_data and clo_idx < clo_q_data|length and global_q_idx in clo_q_data[clo_idx] and clo_q_data[clo_idx][global_q_idx]['w'] != 0 %}{{ clo_q_data[clo_idx][global_q_idx]['w'] }}{% endif %}"
                                       readonly style="background-color: #f8f9fa; color: #495057; font-weight: bold;">
                            </td>
                            <td class="input-cell 
                                {% if exam.name == 'Midterm' %}midterm-col
                                {% elif exam.name == 'Final' %}final-col
                                {% elif exam.name == 'Quiz' %}quiz-col
                                {% elif exam.name == 'Project' %}project-col
                                {% endif %}">
                                <input type="number" step="0.01" min="0" 
                                       name="spm_{{ clo_idx }}_{{ global_q_idx }}" 
                                       value="{% if clo_q_data and clo_idx < clo_q_data|length and global_q_idx in clo_q_data[clo_idx] and clo_q_data[clo_idx][global_q_idx]['spm'] != 0 %}{{ clo_q_data[clo_idx][global_q_idx]['spm'] }}{% endif %}"
                                       readonly style="background-color: #f8f9fa; color: #495057; font-weight: bold;">
                            </td>
                            <td class="input-cell 
                                {% if exam.name == 'Midterm' %}midterm-col
                                {% elif exam.name == 'Final' %}final-col
                                {% elif exam.name == 'Quiz' %}quiz-col
                                {% elif exam.name == 'Project' %}project-col
                                {% endif %}">
                                <input type="number" step="0.1" min="1" max="6" 
                                       name="bl_{{ clo_idx }}_{{ global_q_idx }}" 
                                       value="{% if clo_q_data and clo_idx < clo_q_data|length and global_q_idx in clo_q_data[clo_idx] and clo_q_data[clo_idx][global_q_idx]['bl'] != 0 %}{{ clo_q_data[clo_idx][global_q_idx]['bl'] }}{% endif %}"
                                       readonly style="background-color: #f8f9fa; color: #495057; font-weight: bold;">
                            </td>
                        {% endfor %}
                    {% endfor %}
                    
                    <!-- Performance Values -->
                     <td class="calc-cell" id="max_clo_{{ clo_idx }}">0.000</td>
                     <td class="calc-cell" id="weighted_clo_{{ clo_idx }}">0.000</td>
                     <td class="calc-cell" id="avg_bloom_{{ clo_idx }}">0.000</td>
                     <td class="calc-cell" id="weighted_bl_sum_{{ clo_idx }}">0.00</td>
                </tr>
                {% endfor %}
                
                <!-- Totals Row -->
                <tr class="total-row">
                    <td>TOTAL</td>
                    <td colspan="{{ exams|sum(attribute='question_count') * 4 }}"></td>
                     <td id="total_max_clo">0.000</td>
                     <td id="total_weighted_clo">0.000</td>
                     <td id="total_avg_bloom">0.000</td>
                     <td id="total_weighted_bl_sum">0.00</td>
                </tr>
            </table>
        

        </form>
        

    </div>
</div>

<form id="gradesForm" method="post">
  <div class="tabs">
    {% for exam_idx, exam in enumerate(exams) %}
      <button type="button" class="tab-button {% if loop.first %}active{% endif %}" 
        data-tab="exam-{{ exam_idx }}" 
        data-exam-index="{{ exam_idx }}">
    {{ exam.name }}  
      </button>
    {% endfor %}
    <!-- Overall Button positioned with exam tabs -->
    <button type="button" id="bloomModalBtn" style="
        background: linear-gradient(135deg, #6f42c1, #5a2d91);
        color: white;
        border: 1px solid #6f42c1;
        border-bottom: none;
        padding: 10px 15px;
        cursor: pointer;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
        margin-right: 5px;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(111, 66, 193, 0.3)'" 
       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
        üìä Overall
    </button>
  </div>

  {% for exam_idx, exam in enumerate(exams) %}
    <div id="exam-{{ exam_idx }}" class="tab-content {% if loop.first %}active{% endif %}">
      <h3>Student Information and Grade Entry</h3>
      <table>
        <thead>
          <tr>
            <th class="id-col">ID</th>
            <th class="student-info-col">Student No</th>
            <th class="student-info-col">Name</th>
            {% for q_flat in all_questions_flat %}
              {% if q_flat.exam_idx == exam_idx %} 
                <th class="question-col">Question {{ q_flat.question_idx_in_exam + 1 }}</th>
              {% endif %}
            {% endfor %}
            <th class="total-col">Total</th>
          </tr>
        </thead>
        <tbody>
          {% set current_exam_student_count = students_per_exam[exam_idx] if students_per_exam and exam_idx < students_per_exam|length else student_count %}
          {% for student_idx in range(current_exam_student_count) %}
            <tr class="student-row">
              <td>{{ student_idx + 1 }}</td>
              <td><input type="text" name="student_number_{{ student_idx }}" placeholder="Std. No" style="width:95%;" value="{{ students_data[student_idx].number if students_data[student_idx] else '' }}"></td>
              <td><input type="text" name="student_name_{{ student_idx }}" placeholder="Name" style="width:95%;" value="{{ students_data[student_idx].name if students_data[student_idx] else '' }}"></td>
              {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %} 
                <td>
                  {% set existing_val = 0 %}
                  {% if students_data[student_idx] and students_data[student_idx].grades|length > q_flat.global_question_idx %}
                    {% set existing_val = students_data[student_idx].grades[q_flat.global_question_idx] %}
                  {% endif %}
                  <input type="number" 
                         class="grade-input" 
                         name="grade_{{ student_idx }}_{{ q_flat.global_question_idx }}" 
                         min="0" 
                         max="{{ q_flat.max_points }}" 
                         step="0.1"
                         data-student="{{ student_idx }}" 
                         data-question="{{ q_flat.global_question_idx }}"
                         data-max-points="{{ q_flat.max_points }}"
                         value="{{ existing_val }}"
                         placeholder="0 - {{ q_flat.max_points }}"
                         style="width:60px; border: 1px solid #ccc;"
                         oninput="validateGrade(this)"
                         onblur="validateGradeOnBlur(this)"
                         title="Maksimum {{ q_flat.max_points }} puan girebilirsiniz">
                </td>
                {% endif %}
              {% endfor %}
              <td><input type="text" class="exam-total-input" data-student="{{ student_idx }}" data-exam="{{ exam_idx }}" readonly style="width:50px;" value=""></td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="stats-row">
            <th>Max</th>
            <td colspan="2"></td>
            {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %}
                    <td><input type="text" class="max-q" data-question="{{ q_flat.global_question_idx }}" readonly style="width:40px;"></td>
                {% endif %}
            {% endfor %}
            <td><input type="text" class="max-exam-total" data-exam="{{ exam_idx }}" readonly style="width:50px;"></td>
          </tr>
          
          <tr class="stats-row">
            <th>Min</th>
            <td colspan="2"></td>
            {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %}
                    <td><input type="text" class="min-q" data-question="{{ q_flat.global_question_idx }}" readonly style="width:40px;"></td>
                {% endif %}
            {% endfor %}
            <td><input type="text" class="min-exam-total" data-exam="{{ exam_idx }}" readonly style="width:50px;"></td>
          </tr>
          
          <tr class="stats-row">
            <th>Average</th>
            <td colspan="2"></td>
            {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %}
                    <td><input type="text" class="avg-q" data-question="{{ q_flat.global_question_idx }}" readonly style="width:40px;"></td>
                {% endif %}
            {% endfor %}
            <td><input type="text" class="avg-exam-total" data-exam="{{ exam_idx }}" readonly style="width:50px;"></td>
          </tr>
          
          <tr class="stats-row">
            <th>Median</th>
            <td colspan="2"></td>
            {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %}
                    <td><input type="text" class="median-q" data-question="{{ q_flat.global_question_idx }}" readonly style="width:40px;"></td>
                {% endif %}
            {% endfor %}
            <td><input type="text" class="median-exam-total" data-exam="{{ exam_idx }}" readonly style="width:50px;"></td>
          </tr>
          
          <tr class="total-points-row">
            <th>Total</th>
            <td colspan="2"></td>
            {% set current_exam_total_possible_points = 0 %}
            {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %}
                    <td>{{ q_flat.max_points }}</td>
                    {% set current_exam_total_possible_points = current_exam_total_possible_points + q_flat.max_points %}
                {% endif %}
            {% endfor %}
            <td>{{ current_exam_total_possible_points }}</td> 
          </tr>
          
          <tr class="performance-row">
            <th colspan="3">Student Performance Median (%)</th>
            {% for q_flat in all_questions_flat %}
                {% if q_flat.exam_idx == exam_idx %}
                    <td><input type="text" class="performance-median" data-question="{{ q_flat.global_question_idx }}" readonly style="width:40px;"></td>
                {% endif %}
            {% endfor %}
            <td><input type="text" class="performance-median-exam-total" data-exam="{{ exam_idx }}" readonly style="width:50px;"></td>
          </tr>
        </tfoot>
      </table>
      
      
    </div>
  {% endfor %}

  <br>
<button type="submit" id="saveButton" class="submit-btn">Save and view summary</button>
</form>

<!-- Result Button at bottom -->
<div style="margin-top: 30px; text-align: center;">
    <a href="{{ url_for('bloom_mapping') }}" class="submit-btn" style="background-color: #17a2b8; display: inline-block; margin: 0;">
        üìä Result
    </a>
</div>

<script>
const examsData = JSON.parse('{{ exams | tojson | safe }}');
const studentCount = JSON.parse('{{ student_count | tojson | safe }}');
const allQuestionsFlat = JSON.parse('{{ all_questions_flat | tojson | safe }}'); 


function getColumnValues(globalColIdx) {
  let vals = [];
  for (let i = 0; i < studentCount; i++) {
    let inp = document.querySelector(`input[name='grade_${i}_${globalColIdx}']`);
    if (inp && inp.value !== "" && !isNaN(parseFloat(inp.value))) {
      vals.push(parseFloat(inp.value));
    }
  }
  return vals;
}

function getExamTotalValues(examIdx) {
    let vals = [];
    for (let studentIdx = 0; studentIdx < studentCount; studentIdx++) {
        let total = 0;
        allQuestionsFlat.filter(q => q.exam_idx === examIdx).forEach(q => {
            let inp = document.querySelector(`input[name='grade_${studentIdx}_${q.global_question_idx}']`);
            if (inp && inp.value !== "" && !isNaN(parseFloat(inp.value))) {
                total += parseFloat(inp.value);
            }
        });
        if (!isNaN(total)) {
            vals.push(total);
        }
    }
    return vals;
}

function calcStats(arr) {
  if (arr.length === 0) return {max: '', min: '', avg: '', median: ''};
  
  let sorted = [...arr].sort((a,b) => a - b);
  let sum = arr.reduce((a,b) => a + b, 0);
  let avg = sum / arr.length;
  let median = arr.length % 2 === 1 
    ? sorted[Math.floor(arr.length / 2)]
    : (sorted[arr.length / 2 - 1] + sorted[arr.length / 2]) / 2;
    
  return {
    max: Math.max(...arr),
    min: Math.min(...arr),
    avg: parseFloat(avg.toFixed(1)),
    median: parseFloat(median.toFixed(1))
  };
}

function calculatePerformanceMedianForQuestion(globalQuestionIdx, questionMaxPoints) {
  let vals = getColumnValues(globalQuestionIdx);
  if (vals.length === 0 || questionMaxPoints === 0) return '';
  
  let sortedVals = [...vals].sort((a,b) => a - b);
  let medianValue = sortedVals.length % 2 === 1 
    ? sortedVals[Math.floor(sortedVals.length / 2)]
    : (sortedVals[sortedVals.length / 2 - 1] + sortedVals[sortedVals.length / 2]) / 2;
  
  let performanceMedian = (medianValue / questionMaxPoints) * 100;
  
  return parseFloat(performanceMedian.toFixed(2));
}

function calculateExamPerformanceMedian(examIdx) {
    let studentExamTotals = getExamTotalValues(examIdx);
    if (studentExamTotals.length === 0) return '';

    const currentExamTotalPossiblePoints = allQuestionsFlat
        .filter(q => q.exam_idx === examIdx)
        .reduce((sum, q) => sum + q.max_points, 0);

    if (currentExamTotalPossiblePoints === 0) return '';

    let sortedStudentExamTotals = [...studentExamTotals].sort((a,b) => a - b);
    let medianExamTotalValue = sortedStudentExamTotals.length % 2 === 1 
      ? sortedStudentExamTotals[Math.floor(sortedStudentExamTotals.length / 2)]
      : (sortedStudentExamTotals[sortedStudentExamTotals.length / 2 - 1] + sortedStudentExamTotals[sortedStudentExamTotals.length / 2]) / 2;
        
    let performanceMedian = (medianExamTotalValue / currentExamTotalPossiblePoints) * 100;
    return parseFloat(performanceMedian.toFixed(2));
}


function recalcCurrentTabStats() {
    const activeTabContent = document.querySelector('.tab-content.active');
    if (!activeTabContent) return; 

    const activeTabId = activeTabContent.id;
    const activeExamIdx = parseInt(activeTabId.replace('exam-', ''));
    
    const currentExamQuestions = allQuestionsFlat.filter(q => q.exam_idx === activeExamIdx);

    for (let i = 0; i < studentCount; i++) {
        let total = 0;
        currentExamQuestions.forEach(q => {
            let inp = document.querySelector(`input[name='grade_${i}_${q.global_question_idx}']`);
            if (inp && inp.value !== "" && !isNaN(parseFloat(inp.value))) {
                total += parseFloat(inp.value);
            }
        });
        let totalInput = document.querySelector(`.exam-total-input[data-student='${i}'][data-exam='${activeExamIdx}']`);
        if (totalInput) {
            totalInput.value = total.toFixed(1); 
        }
    }
    
    for (let q = 0; q < currentExamQuestions.length; q++) {
        let globalQIdx = currentExamQuestions[q].global_question_idx;
        let vals = getColumnValues(globalQIdx);
        let stats = calcStats(vals);
        
        let maxInput = activeTabContent.querySelector(`.max-q[data-question='${globalQIdx}']`);
        let minInput = activeTabContent.querySelector(`.min-q[data-question='${globalQIdx}']`);
        let avgInput = activeTabContent.querySelector(`.avg-q[data-question='${globalQIdx}']`);
        let medianInput = activeTabContent.querySelector(`.median-q[data-question='${globalQIdx}']`);
        
        if (maxInput) maxInput.value = stats.max !== '' ? stats.max.toFixed(1) : '';
        if (minInput) minInput.value = stats.min !== '' ? stats.min.toFixed(1) : '';
        if (avgInput) avgInput.value = stats.avg !== '' ? stats.avg.toFixed(1) : '';
        if (medianInput) medianInput.value = stats.median !== '' ? stats.median.toFixed(1) : '';
        
        let perfMedian = calculatePerformanceMedianForQuestion(globalQIdx, currentExamQuestions[q].max_points);
        let perfInput = activeTabContent.querySelector(`.performance-median[data-question='${globalQIdx}']`);
        if (perfInput) perfInput.value = perfMedian !== '' ? perfMedian.toFixed(2) : '';
    }
    
    let examTotalVals = getExamTotalValues(activeExamIdx);
    let tStats = calcStats(examTotalVals);
    
    let maxTotalInput = activeTabContent.querySelector(`.max-exam-total[data-exam='${activeExamIdx}']`);
    let minTotalInput = activeTabContent.querySelector(`.min-exam-total[data-exam='${activeExamIdx}']`);
    let avgTotalInput = activeTabContent.querySelector(`.avg-exam-total[data-exam='${activeExamIdx}']`);
    let medianTotalInput = activeTabContent.querySelector(`.median-exam-total[data-exam='${activeExamIdx}']`);
    
    if (maxTotalInput) maxTotalInput.value = tStats.max !== '' ? tStats.max.toFixed(1) : '';
    if (minTotalInput) minTotalInput.value = tStats.min !== '' ? tStats.min.toFixed(1) : '';
    if (avgTotalInput) avgTotalInput.value = tStats.avg !== '' ? tStats.avg.toFixed(1) : '';
    if (medianTotalInput) medianTotalInput.value = tStats.median !== '' ? tStats.median.toFixed(1) : '';

    let examPerfMedian = calculateExamPerformanceMedian(activeExamIdx);
    let perfExamTotalInput = activeTabContent.querySelector(`.performance-median-exam-total[data-exam='${activeExamIdx}']`);
    if (perfExamTotalInput) perfExamTotalInput.value = examPerfMedian !== '' ? examPerfMedian.toFixed(2) : '';
}

function openTab(event, tabId) {
    document.querySelectorAll('.tab-content').forEach(tabContent => {
        tabContent.classList.remove('active');
    });

    document.querySelectorAll('.tab-button').forEach(tabButton => {
        tabButton.classList.remove('active');
    });

    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');

         // Update download button link with this new code block
     const examIndex = event.currentTarget.getAttribute('data-exam-index');
     //this part changed
    const form = document.getElementById('gradesForm');
    form.action = `/student_grades`;
    form.method = 'post';

    recalcCurrentTabStats();
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', (event) => {
      openTab(event, button.dataset.tab);
    });
  });

  document.querySelectorAll('.grade-input').forEach(function(inp) {
    inp.addEventListener('input', recalcCurrentTabStats);
    inp.addEventListener('change', recalcCurrentTabStats);
    
    // Not validasyonu - maksimum puanƒ± a≈ümayƒ± engelle
    inp.addEventListener('input', function() {
      const maxPoints = parseFloat(this.getAttribute('max'));
      const currentValue = parseFloat(this.value);
      
      if (currentValue > maxPoints) {
        this.value = maxPoints;
        // Kullanƒ±cƒ±ya uyarƒ± g√∂ster
        showNotification(`Bu soru maksimum ${maxPoints} puan alabilir!`, 'warning');
      }
    });
    
             // Auto-save (after 3 seconds)
    let saveTimer;
    inp.addEventListener('input', function() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        const examIdx = this.closest('.tab-content').id.replace('exam-', '');
        
        // Auto-save all student data for this exam
        const examData = {
            exam_idx: parseInt(examIdx),
            students: []
        };
        
        const currentTab = document.getElementById(`exam-${examIdx}`);
        const studentRows = currentTab.querySelectorAll('.student-row');
        
        studentRows.forEach((row, studentIdx) => {
            const studentNumber = row.querySelector('input[name^="student_number_"]').value;
            const studentName = row.querySelector('input[name^="student_name_"]').value;
            const grades = [];
            
            // Get grades for this exam - use global question indices
            const currentExamQuestions = allQuestionsFlat.filter(q => q.exam_idx === parseInt(examIdx));
            currentExamQuestions.forEach(question => {
                const gradeInput = row.querySelector(`input[name="grade_${studentIdx}_${question.global_question_idx}"]`);
                const grade = gradeInput ? (parseFloat(gradeInput.value) || 0) : 0;
                grades.push(grade);
            });
            
            examData.students.push({
                student_idx: studentIdx,
                number: studentNumber,
                name: studentName,
                grades: grades
            });
        });
        
        // Auto-save to database via AJAX
        fetch('/save_exam_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(examData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Auto-save successful');
            } else {
                console.log('Auto-save error: ' + data.error);
            }
        })
        .catch(error => {
            console.log('Auto-save connection error: ' + error);
        });
        
        // Update SPM values when student grade changes
        console.log('Student grade changed, updating SPM...');
        setTimeout(function() {
            calculateAllSPMValues();
            // Bloom modal a√ßƒ±ksa tabloyu da g√ºncelle
            const bloomModal = document.getElementById('bloomModal');
            if (bloomModal && bloomModal.style.display === 'block') {
                updateBloomMappingTable();
            }
        }, 1000);
      }, 3000);
    });
  });
  
     // Set the first tab's link when page loads
   const downloadButton = document.getElementById('downloadCsvButton');
  const form = document.getElementById('gradesForm');

    if (downloadButton) {
        downloadButton.addEventListener('click', function() {
            const activeTabButton = document.querySelector('.tab-button.active');
            if (activeTabButton) {
                const examIndex = activeTabButton.getAttribute('data-exam-index');
                form.action = `/download_csv/${examIndex}`;
                form.method = 'post';
                form.submit();
            }
        });
    }

    // Modal functionality
    const modal = document.getElementById('bloomModal');
    const btn = document.getElementById('bloomModalBtn');
    const span = document.getElementsByClassName('close')[0];

    // Open modal
    btn.onclick = function(event) {
        event.preventDefault(); // Prevent any default behavior
        event.stopPropagation(); // Stop event bubbling
        modal.style.display = 'block';
        // Perform automatic calculation after modal opens
        setTimeout(autoCalculateBloomMapping, 300);
    }



    // Close modal
    span.onclick = function(event) {
        event.preventDefault();
        event.stopPropagation();
        modal.style.display = 'none';
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
        if (event.target == modal) {
            event.preventDefault();
            modal.style.display = 'none';
        }
    }

         // Calculate SPM values when page loads (if student grades exist)
    setTimeout(function() {
                 console.log('Page loaded, checking SPM values...');
        const gradeInputs = document.querySelectorAll('.grade-input');
        let hasGrades = false;
        gradeInputs.forEach(input => {
            if (input.value.trim() !== '' && parseFloat(input.value) > 0) {
                hasGrades = true;
            }
        });
        
                 if (hasGrades) {
             console.log('Student grades found, calculating SPM values...');
             calculateAllSPMValues();
         }
        
                 // Bloom modal a√ßƒ±ksa tabloyu da g√ºncelle
         const bloomModal = document.getElementById('bloomModal');
         if (bloomModal && bloomModal.style.display === 'block') {
             console.log('Bloom modal is open, updating table...');
             updateBloomMappingTable();
         }
    }, 1000);

    // Global SPM storage
    let globalSPMValues = {};
    
         // Calculate SPM values for all questions
     function calculateAllSPMValues() {
         console.log('Calculating SPM values for all questions...');
        
        const exams = JSON.parse('{{ exams | tojson | safe }}');
        const allQuestionsFlat = JSON.parse('{{ all_questions_flat | tojson | safe }}');
        const studentCount = parseInt('{{ student_count }}');
        
                 // Clear global SPM storage
         globalSPMValues = {};
        
                 // Calculate SPM for each question
         allQuestionsFlat.forEach((question, index) => {
            const globalQIdx = question.global_question_idx;
            const examIdx = question.exam_idx;
            const questionIdxInExam = question.question_idx_in_exam;
            const maxPoints = question.max_points;
            
            console.log(`Processing Q${questionIdxInExam + 1} from Exam ${examIdx + 1} (GlobalIdx: ${globalQIdx}, MaxPoints: ${maxPoints})`);
            
                         // Collect student grades
             const gradesForQuestion = [];
            for (let studentIdx = 0; studentIdx < studentCount; studentIdx++) {
                const gradeInput = document.querySelector(`input[name="grade_${studentIdx}_${globalQIdx}"]`);
                if (gradeInput && gradeInput.value.trim() !== '') {
                    const gradeValue = parseFloat(gradeInput.value.trim());
                    if (!isNaN(gradeValue) && gradeValue >= 0) {
                        gradesForQuestion.push(gradeValue);
                    }
                }
            }
            
            console.log(`Grades for Q${questionIdxInExam + 1}:`, gradesForQuestion);
            
                         // Calculate SPM
             let spmValue = 0;
            if (gradesForQuestion.length > 0 && maxPoints > 0) {
                const sortedGrades = [...gradesForQuestion].sort((a, b) => a - b);
                let median;
                if (sortedGrades.length % 2 === 0) {
                    median = (sortedGrades[sortedGrades.length / 2 - 1] + sortedGrades[sortedGrades.length / 2]) / 2;
                } else {
                    median = sortedGrades[Math.floor(sortedGrades.length / 2)];
                }
                
                spmValue = (median / maxPoints) * 100;
                console.log(`SPM calculation for Q${questionIdxInExam + 1}: median=${median}, maxPoints=${maxPoints}, SPM=${spmValue.toFixed(2)}%`);
            } else {
                console.log(`No grades found for Q${questionIdxInExam + 1} or maxPoints is 0`);
            }
            
                         // Save to global storage
             globalSPMValues[globalQIdx] = spmValue;
            console.log(`Saved SPM for Q${questionIdxInExam + 1} (GlobalIdx: ${globalQIdx}): ${spmValue.toFixed(2)}%`);
        });
        
        console.log('Final Global SPM values:', globalSPMValues);
        
                 // Update table if Bloom modal is open
         const bloomModal = document.getElementById('bloomModal');
         if (bloomModal && bloomModal.style.display === 'block') {
             console.log('Bloom modal is open, updating table...');
             updateBloomMappingTable();
         }
    }
    
         // Update Bloom mapping table
     function updateBloomMappingTable() {
         console.log('Updating Bloom mapping table...');
        
        const exams = JSON.parse('{{ exams | tojson | safe }}');
        const questionPoints = JSON.parse('{{ question_points_nested | tojson | safe }}');
        const clos = JSON.parse('{{ clos | tojson | safe }}');
        const allQuestionsFlat = JSON.parse('{{ all_questions_flat | tojson | safe }}');
        
        clos.forEach((clo, cloIdx) => {
            console.log(`Updating CLO ${cloIdx + 1}...`);
            
            allQuestionsFlat.forEach((question) => {
                const globalQIdx = question.global_question_idx;
                const examIdx = question.exam_idx;
                const questionIdxInExam = question.question_idx_in_exam;
                
                // Check if this CLO belongs to this question
                let isCLOSelected = false;
                let qctValue = 0;
                let wValue = 0;
                let blValue = 0;
                
                // Find CLO information for this question from question points
                if (questionPoints && questionPoints[examIdx]) {
                    for (let qp of questionPoints[examIdx]) {
                        if (qp.question_idx === questionIdxInExam && qp.clo === clo) {
                            isCLOSelected = true;
                            qctValue = qp.qct || 0;
                            wValue = qp.w || 0;
                            blValue = qp.bl || 0;
                            break;
                        }
                    }
                }
                
                // Find input fields
                const qctInput = document.querySelector(`input[name="qct_${cloIdx}_${globalQIdx}"]`);
                const wInput = document.querySelector(`input[name="w_${cloIdx}_${globalQIdx}"]`);
                const spmInput = document.querySelector(`input[name="spm_${cloIdx}_${globalQIdx}"]`);
                const blInput = document.querySelector(`input[name="bl_${cloIdx}_${globalQIdx}"]`);
                
                if (isCLOSelected) {
                    // Get SPM value from global storage
                    let spmValue = globalSPMValues[globalQIdx] || 0;
                    
                    // Update input fields
                    if (qctInput) {
                        qctInput.value = qctValue.toFixed(2);
                        qctInput.style.backgroundColor = '#fff3cd';
                        qctInput.style.fontWeight = 'bold';
                    }
                    if (wInput) {
                        wInput.value = wValue.toFixed(3);
                        wInput.style.backgroundColor = '#fff3cd';
                        wInput.style.fontWeight = 'bold';
                    }
                    if (spmInput) {
                        spmInput.value = spmValue.toFixed(2);
                        spmInput.style.backgroundColor = '#fff3cd';
                        spmInput.style.fontWeight = 'bold';
                    }
                    if (blInput) {
                        blInput.value = blValue.toFixed(1);
                        blInput.style.backgroundColor = '#fff3cd';
                        blInput.style.fontWeight = 'bold';
                    }
                    
                    console.log(`Updated CLO ${cloIdx + 1}, Q${questionIdxInExam + 1}: QCT=${qctValue.toFixed(2)}, W=${wValue.toFixed(3)}, SPM=${spmValue.toFixed(2)}, BL=${blValue.toFixed(1)}`);
                } else {
                    // Clear fields if CLO is not selected
                    if (qctInput) {
                        qctInput.value = '';
                        qctInput.style.backgroundColor = '#f8f9fa';
                        qctInput.style.fontWeight = 'normal';
                    }
                    if (wInput) {
                        wInput.value = '';
                        wInput.style.backgroundColor = '#f8f9fa';
                        wInput.style.fontWeight = 'normal';
                    }
                    if (spmInput) {
                        spmInput.value = '';
                        spmInput.style.backgroundColor = '#f8f9fa';
                        spmInput.style.fontWeight = 'normal';
                    }
                    if (blInput) {
                        blInput.value = '';
                        blInput.style.backgroundColor = '#f8f9fa';
                        blInput.style.fontWeight = 'normal';
                    }
                }
            });
        });
        
        // Also update CLO Score table
        updateCLOScoreTable();
    }
    
    // Automatic calculation function
    function autoCalculateBloomMapping() {
        console.log('Automatically calculating Bloom Mapping...');
        
        // First calculate SPM values for all questions
        calculateAllSPMValues();
        
        // Then update Bloom mapping table
        updateBloomMappingTable();
        
        console.log('Bloom Mapping automatic calculation completed!');
    }
    
    // Calculate and update CLO Score table
    function updateCLOScoreTable() {
        console.log('Updating CLO Score table...');
        
        const clos = JSON.parse('{{ clos | tojson | safe }}');
        const questionPoints = JSON.parse('{{ question_points_nested | tojson | safe }}');
        const allQuestionsFlat = JSON.parse('{{ all_questions_flat | tojson | safe }}');
        
        clos.forEach((clo, cloIdx) => {
            let qctList = [];
            let wList = [];
            let spmList = [];
            let blList = [];
            
            // Collect all values for this CLO
            allQuestionsFlat.forEach((question) => {
                const globalQIdx = question.global_question_idx;
                const examIdx = question.exam_idx;
                const questionIdxInExam = question.question_idx_in_exam;
                
                // Check if this CLO belongs to this question
                let isCLOSelected = false;
                if (questionPoints && questionPoints[examIdx]) {
                    for (let qp of questionPoints[examIdx]) {
                        if (qp.question_idx === questionIdxInExam && qp.clo === clo) {
                            isCLOSelected = true;
                            break;
                        }
                    }
                }
                
                if (isCLOSelected) {
                    // Get QCT, W, SPM, BL values
                    const qctInput = document.querySelector(`input[name="qct_${cloIdx}_${globalQIdx}"]`);
                    const wInput = document.querySelector(`input[name="w_${cloIdx}_${globalQIdx}"]`);
                    const spmInput = document.querySelector(`input[name="spm_${cloIdx}_${globalQIdx}"]`);
                    const blInput = document.querySelector(`input[name="bl_${cloIdx}_${globalQIdx}"]`);
                    
                    if (qctInput && qctInput.value) qctList.push(parseFloat(qctInput.value));
                    if (wInput && wInput.value) wList.push(parseFloat(wInput.value));
                    if (spmInput && spmInput.value) spmList.push(parseFloat(spmInput.value));
                    if (blInput && blInput.value) blList.push(parseFloat(blInput.value));
                }
            });
            
            // CLO Score calculations
            let maxCLOScore = 0;
            let weightedCLOScore = 0;
            let normalizedCLOScore = 0;
            let averageBloomScore = 0;
            let weightedBloomSum = 0;
            
            if (qctList.length > 0 && wList.length > 0) {
                // Max CLO Score = Œ£(QCT·µ¢/100 √ó W·µ¢)
                maxCLOScore = qctList.reduce((sum, qct, idx) => {
                    return sum + ((qct / 100) * wList[idx]);
                }, 0);
                
                // Weighted CLO Score = Œ£(QCT·µ¢/100 √ó W·µ¢ √ó SPM·µ¢/100)
                if (spmList.length > 0) {
                    weightedCLOScore = qctList.reduce((sum, qct, idx) => {
                        return sum + ((qct / 100) * wList[idx] * (spmList[idx] / 100));
                    }, 0);
                    
                    // Normalized CLO Score = (Weighted CLO Score / Max CLO Score) √ó 100
                    if (maxCLOScore > 0) {
                        normalizedCLOScore = (weightedCLOScore / maxCLOScore) * 100;
                    }
                }
                
                // Average Bloom Score = Œ£(QCT·µ¢/100 √ó W·µ¢ √ó BL·µ¢) / Œ£(QCT·µ¢/100 √ó W·µ¢)
                if (blList.length > 0) {
                    weightedBloomSum = qctList.reduce((sum, qct, idx) => {
                        return sum + ((qct / 100) * wList[idx] * blList[idx]);
                    }, 0);
                    
                    if (maxCLOScore > 0) {
                        averageBloomScore = weightedBloomSum / maxCLOScore;
                    }
                }
                
                console.log(`CLO ${cloIdx + 1} calculations:`);
                console.log(`- QCT List:`, qctList);
                console.log(`- W List:`, wList);
                console.log(`- SPM List:`, spmList);
                console.log(`- BL List:`, blList);
                console.log(`- Max CLO Score: ${maxCLOScore.toFixed(3)}`);
                console.log(`- Weighted CLO Score: ${weightedCLOScore.toFixed(3)}`);
                console.log(`- Average Bloom Score: ${averageBloomScore.toFixed(3)}`);
                console.log(`- Weighted BL Sum: ${weightedBloomSum.toFixed(2)}`);
            }
            
            // Update CLO Score table - with IDs
            const maxCLOCell = document.getElementById(`max_clo_${cloIdx}`);
            const weightedCLOCell = document.getElementById(`weighted_clo_${cloIdx}`);
            const averageBLCell = document.getElementById(`avg_bloom_${cloIdx}`);
            const weightedBLSumCell = document.getElementById(`weighted_bl_sum_${cloIdx}`);
            
            if (maxCLOCell) maxCLOCell.textContent = maxCLOScore.toFixed(3);
            if (weightedCLOCell) weightedCLOCell.textContent = weightedCLOScore.toFixed(3);
            if (averageBLCell) averageBLCell.textContent = averageBloomScore.toFixed(3);
            if (weightedBLSumCell) weightedBLSumCell.textContent = weightedBloomSum.toFixed(2);
            
            console.log(`CLO ${cloIdx + 1}: Max=${maxCLOScore.toFixed(3)}, Weighted=${weightedCLOScore.toFixed(3)}, AvgBL=${averageBloomScore.toFixed(3)}, WeightedBLSum=${weightedBloomSum.toFixed(2)}`);
        });
        
        // Update TOTAL row
        updateTotalRow();
        
        console.log('CLO Score table updated!');
    }
    
         // TOTAL satƒ±rƒ±nƒ± g√ºncelle
     function updateTotalRow() {
         const clos = JSON.parse('{{ clos | tojson | safe }}');
         
         let totalMaxCLO = 0;
         let totalWeightedCLO = 0;
         let totalAverageBL = 0;
         let totalWeightedBLSum = 0;
         
         clos.forEach((clo, cloIdx) => {
             const maxCLOCell = document.getElementById(`max_clo_${cloIdx}`);
             const weightedCLOCell = document.getElementById(`weighted_clo_${cloIdx}`);
             const averageBLCell = document.getElementById(`avg_bloom_${cloIdx}`);
             const weightedBLSumCell = document.getElementById(`weighted_bl_sum_${cloIdx}`);
             
             if (maxCLOCell && maxCLOCell.textContent) totalMaxCLO += parseFloat(maxCLOCell.textContent);
             if (weightedCLOCell && weightedCLOCell.textContent) totalWeightedCLO += parseFloat(weightedCLOCell.textContent);
             if (averageBLCell && averageBLCell.textContent) totalAverageBL += parseFloat(averageBLCell.textContent);
             if (weightedBLSumCell && weightedBLSumCell.textContent) totalWeightedBLSum += parseFloat(weightedBLSumCell.textContent);
         });
         
         // Update cells in TOTAL row - with IDs
         const totalMaxCLOCell = document.getElementById('total_max_clo');
         const totalWeightedCLOCell = document.getElementById('total_weighted_clo');
         const totalAverageBLCell = document.getElementById('total_avg_bloom');
         const totalWeightedBLSumCell = document.getElementById('total_weighted_bl_sum');
         
         if (totalMaxCLOCell) totalMaxCLOCell.textContent = totalMaxCLO.toFixed(3);
         if (totalWeightedCLOCell) totalWeightedCLOCell.textContent = totalWeightedCLO.toFixed(3);
         if (totalAverageBLCell) totalAverageBLCell.textContent = totalAverageBL.toFixed(3);
         if (totalWeightedBLSumCell) totalWeightedBLSumCell.textContent = totalWeightedBLSum.toFixed(2);
         
         console.log(`TOTAL: Max=${totalMaxCLO.toFixed(3)}, Weighted=${totalWeightedCLO.toFixed(3)}, AvgBL=${totalAverageBL.toFixed(3)}, WeightedBLSum=${totalWeightedBLSum.toFixed(2)}`);
     }

             // Perform automatic calculation when page loads
         document.addEventListener('DOMContentLoaded', function() {
             // Perform automatic calculation when Bloom modal opens
             const bloomModalBtn = document.getElementById('bloomModalBtn');
        if (bloomModalBtn) {
            bloomModalBtn.addEventListener('click', function() {
                                 console.log('Bloom Modal button clicked');
                 // Perform calculation after modal opens
                setTimeout(autoCalculateBloomMapping, 200);
            });
        }
        
                 // Also perform automatic calculation when page loads (if modal is already open)
         setTimeout(() => {
             const bloomModal = document.getElementById('bloomModal');
             if (bloomModal && bloomModal.style.display === 'block') {
                 console.log('Page loaded, modal is open, performing automatic calculation...');
                 autoCalculateBloomMapping();
             }
         }, 1000);
    });

    setTimeout(recalcCurrentTabStats, 100);
    
    // Sayfa y√ºklendiƒüinde mevcut notlarƒ± validasyon i√ßin kontrol et
    setTimeout(() => {
      document.querySelectorAll('.grade-input').forEach(input => {
        validateGradeOnBlur(input);
      });
    }, 200);
    
    // Bildirim g√∂sterme fonksiyonu
    function showNotification(message, type = 'info') {
      // Mevcut bildirimi kaldƒ±r
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Yeni bildirim olu≈ütur
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()">&times;</button>
      `;
      
      // Stil ekle
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
      `;
      
      // Tip'e g√∂re renk belirle
      if (type === 'warning') {
        notification.style.backgroundColor = '#ff9800';
      } else if (type === 'error') {
        notification.style.backgroundColor = '#f44336';
      } else if (type === 'success') {
        notification.style.backgroundColor = '#4caf50';
      } else {
        notification.style.backgroundColor = '#2196f3';
      }
      
      // Kapatma butonu stili
      const closeBtn = notification.querySelector('button');
      closeBtn.style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        margin-left: 10px;
      `;
      
      // CSS animasyonu ekle
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      // Sayfaya ekle
      document.body.appendChild(notification);
      
      // 5 saniye sonra otomatik kaldƒ±r
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
    }
    
    // Global scope'a ekle
    window.showNotification = showNotification;
    
    // Not validasyonu fonksiyonu
    function validateGrade(input) {
      const maxPoints = parseFloat(input.getAttribute('data-max-points'));
      const currentValue = parseFloat(input.value);
      
      // Negatif deƒüer kontrol√º
      if (currentValue < 0) {
        input.value = 0;
        showNotification('Not negatif olamaz!', 'error');
        return;
      }
      
      // Maksimum puan kontrol√º
      if (currentValue > maxPoints) {
        input.value = maxPoints;
        showNotification(`Bu soru maksimum ${maxPoints} puan alabilir!`, 'warning');
        return;
      }
      
      // Ondalƒ±k hassasiyet kontrol√º (0.1'e yuvarla)
      const roundedValue = Math.round(currentValue * 10) / 10;
      if (roundedValue !== currentValue) {
        input.value = roundedValue;
      }
    }
    
    // Global scope'a ekle
    window.validateGrade = validateGrade;
    
    // Blur event'inde validasyon
    function validateGradeOnBlur(input) {
      const maxPoints = parseFloat(input.getAttribute('data-max-points'));
      const currentValue = parseFloat(input.value);
      
      if (isNaN(currentValue)) {
        input.value = 0;
        input.classList.remove('warning', 'valid');
        input.classList.add('error');
        return;
      }
      
      if (currentValue < 0) {
        input.value = 0;
        input.classList.remove('warning', 'valid');
        input.classList.add('error');
        return;
      }
      
      if (currentValue > maxPoints) {
        input.value = maxPoints;
        input.classList.remove('error', 'valid');
        input.classList.add('warning');
        return;
      }
      
      // Ge√ßerli deƒüer
      input.classList.remove('error', 'warning');
      input.classList.add('valid');
    }
    
    // Global scope'a ekle
    window.validateGradeOnBlur = validateGradeOnBlur;
    

});
</script>
</body>
</html>